<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}AI Library Hub{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    {% if session.user_id %}
    <nav>
        <div class="container">
            <h1><a href="{{ url_for('dashboard') }}">AI Library Hub</a></h1>
            <ul>
                <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                <li><a href="{{ url_for('book_resource') }}">Book Resource</a></li>
                <li><a href="{{ url_for('recommendations') }}">Recommendations</a></li>
                <li><a href="{{ url_for('profile') }}">Profile</a></li>
                <li><a href="{{ url_for('logout') }}">Logout</a></li>
            </ul>
        </div>
    </nav>
    {% endif %}

    <main class="container">
        {% block content %}{% endblock %}
    </main>

    {% if session.user_id %}
    <div class="chatbot-container">
        <div class="chatbot-header" onclick="toggleChatbot()">AI Assistant</div>
        <div class="chatbot-body" id="chatbot-body">
            <div class="chat-message bot-message">Hello, {{ session.username }}! How can I help you today?</div>
        </div>
        <div class="chatbot-input">
            <input type="text" id="chatbot-input-field" placeholder="Ask me anything..." onkeydown="handleKeydown(event)">
            <button onclick="sendChatMessage()">Send</button>
        </div>
    </div>

    <script>
        function toggleChatbot() {
            const chatbotBody = document.getElementById('chatbot-body');
            const chatbotInput = document.querySelector('.chatbot-input');
            if (chatbotBody.style.display === 'none') {
                chatbotBody.style.display = 'flex';
                chatbotInput.style.display = 'flex';
            } else {
                chatbotBody.style.display = 'none';
                chatbotInput.style.display = 'none';
            }
        }

        function handleKeydown(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        async function sendChatMessage() {
            const inputField = document.getElementById('chatbot-input-field');
            const chatBody = document.getElementById('chatbot-body');
            const query = inputField.value.trim();

            if (query === '') return;

            // Display user message
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'chat-message user-message';
            userMessageDiv.textContent = query;
            chatBody.appendChild(userMessageDiv);

            inputField.value = '';
            chatBody.scrollTop = chatBody.scrollHeight;

            // Get bot response
            try {
                const response = await fetch('/chatbot', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: query })
                });
                const data = await response.json();

                const botMessageDiv = document.createElement('div');
                botMessageDiv.className = 'chat-message bot-message';
                botMessageDiv.textContent = data.response;
                chatBody.appendChild(botMessageDiv);
                chatBody.scrollTop = chatBody.scrollHeight;

            } catch (error) {
                console.error('Chatbot error:', error);
                const errorMessageDiv = document.createElement('div');
                errorMessageDiv.className = 'chat-message bot-message';
                errorMessageDiv.textContent = 'Sorry, I am having trouble connecting. Please try again later.';
                chatBody.appendChild(errorMessageDiv);
                chatBody.scrollTop = chatBody.scrollHeight;
            }
        }
    </script>
    {% endif %}
</body>
</html>