{% extends "layout.html" %}
{% block title %}Profile{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='profile.css') }}">
{% endblock %}

{% block content %}
<div class="profile-container">
    <aside class="profile-sidebar">
        <div class="profile-avatar">
            {% if user.avatar and user.avatar != 'profile_avatar.png' %}
                <img src="{{ url_for('static', filename='img/' + user.avatar) }}" alt="User Avatar">
            {% else %}
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjgwIiBoZWlnaHQ9IjI4MCIgdmlld0JveD0iMCAwIDI4MCAyODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjE0MCIgY3k9IjE0MCIgcj0iMTQwIiBmaWxsPSIjNDI4NUY0Ii8+Cjx0ZXh0IHg9IjE0MCIgeT0iMTYwIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjgwIiBmb250LXdlaWdodD0iYm9sZCI+{{ user.name[0]|upper if user.name else user.username[0]|upper }}</text></svg>" alt="User Avatar">
            {% endif %}
        </div>
        
        <div class="profile-info">
            <h2 class="profile-name">{{ user.name }}</h2>
            <p class="profile-username">@{{ user.username }}</p>
            
            <div class="profile-details">
                <div class="detail-item">
                    <i class="fas fa-graduation-cap"></i>
                    <span>{{ user.major if user.major else 'Computer Science Student' }}</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span>{{ user.year if user.year else 'Year 3' }}</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-university"></i>
                    <span>University of Richmond</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Richmond, VA</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-envelope"></i>
                    <span>{{ user.email if user.email else user.username + '@richmond.edu' }}</span>
                </div>
            </div>
            
            <a href="{{ url_for('settings') }}" class="edit-profile-btn">
                <i class="fas fa-edit"></i>
                Edit profile
            </a>
        </div>
        
        <div class="profile-sections">
            <div class="section-item rewards">
                <div class="section-header">
                    <i class="fas fa-trophy"></i>
                    <h3>Achievements</h3>
                </div>
                <div class="section-content">
                    <div class="achievement-badge pro">
                        <i class="fas fa-star"></i>
                        <span>PRO Member</span>
                    </div>
                    <div class="achievement-badge reader">
                        <i class="fas fa-book"></i>
                        <span>Avid Reader</span>
                    </div>
                </div>
            </div>
            
            <div class="section-item organizations">
                <div class="section-header">
                    <i class="fas fa-building"></i>
                    <h3>Organizations</h3>
                </div>
                <div class="section-content">
                    <div class="org-item">
                        <span class="org-logo">UR</span>
                        <span class="org-name">University of Richmond</span>
                    </div>
                    <div class="org-item">
                        <span class="org-logo cs">CS</span>
                        <span class="org-name">Computer Science Club</span>
                    </div>
                </div>
            </div>
        </div>
    </aside>
    <main class="profile-main">
        <section class="loan-list card">
            <h3>Loan List</h3>
            <div class="loan-items-container">
                {% if user.borrowed_books_details %}
                    {% for book in user.borrowed_books_details %}
                    <div class="loan-item-block">
                        <div class="loan-content">
                            <div class="book-main-info">
                                <h4 class="book-title">{{ book.title }}</h4>
                                <p class="book-author">by {{ book.author }}</p>
                                <p class="book-isbn">ISBN: {{ book.isbn }}</p>
                            </div>
                            <div class="loan-details">
                                <div class="detail-item">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>Due: {{ book.dueDate if book.dueDate else '15/10/2025, 23:59' }}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Return to: {{ book.location }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="loan-actions">
                            <button class="renew-btn"><i class="fas fa-sync-alt"></i> RENEW</button>
                            <button class="details-btn"><i class="fas fa-info-circle"></i> DETAILS</button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-loans">
                        <p>No books currently borrowed.</p>
                    </div>
                {% endif %}
            </div>
        </section>

        <section class="resources-allocated card">
            <h3>Resources Allocated</h3>
            <div class="resources-grid">
                <div class="resource-item" data-resource="printing">
                    <div class="resource-chart" data-percentage="{{ user.resource_allocation.printing }}">
                        <svg class="progress-ring" width="100" height="100">
                            <circle class="progress-ring-circle-bg" cx="50" cy="50" r="40"></circle>
                            <circle class="progress-ring-circle" cx="50" cy="50" r="40" data-color="#e91e63"></circle>
                        </svg>
                        <div class="resource-icon">
                            <i class="fas fa-print"></i>
                        </div>
                    </div>
                    <div class="resource-label">Printing Quota</div>
                </div>
                
                <div class="resource-item" data-resource="studyroom">
                    <div class="resource-chart" data-percentage="{{ user.resource_allocation.studyroom }}">
                        <svg class="progress-ring" width="100" height="100">
                            <circle class="progress-ring-circle-bg" cx="50" cy="50" r="40"></circle>
                            <circle class="progress-ring-circle" cx="50" cy="50" r="40" data-color="#9e9e9e"></circle>
                        </svg>
                        <div class="resource-icon">
                            <i class="fas fa-door-open"></i>
                        </div>
                    </div>
                    <div class="resource-label">Study Room Hours</div>
                </div>
                
                <div class="resource-item" data-resource="devices">
                    <div class="resource-chart" data-percentage="{{ user.resource_allocation.devices }}">
                        <svg class="progress-ring" width="100" height="100">
                            <circle class="progress-ring-circle-bg" cx="50" cy="50" r="40"></circle>
                            <circle class="progress-ring-circle" cx="50" cy="50" r="40" data-color="#4caf50"></circle>
                        </svg>
                        <div class="resource-icon">
                            <i class="fas fa-laptop"></i>
                        </div>
                    </div>
                    <div class="resource-label">Device Lending</div>
                </div>
                
                <div class="resource-item" data-resource="workshops">
                    <div class="resource-chart" data-percentage="{{ user.resource_allocation.workshops }}">
                        <svg class="progress-ring" width="100" height="100">
                            <circle class="progress-ring-circle-bg" cx="50" cy="50" r="40"></circle>
                            <circle class="progress-ring-circle" cx="50" cy="50" r="40" data-color="#ff5722"></circle>
                        </svg>
                        <div class="resource-icon">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    <div class="resource-label">Workshop Bookings</div>
                </div>
            </div>
        </section>

        <!-- Resource Detail Modal -->
        <div id="resourceModal" class="resource-modal">
            <div class="resource-modal-content">
                <span class="resource-modal-close">&times;</span>
                <h3 id="resourceModalTitle">Resource Details</h3>
                <div id="resourceModalBody">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Tooltip -->
        <div id="resourceTooltip" class="resource-tooltip"></div>

        <section class="booking-activity card">
            <div class="activity-header">
                <h3>{{ user.borrowed_books|length + user.user_bookings|length + user.workshop_registrations|length }} activities in the last year</h3>
                <div class="activity-summary">
                    <span class="total-books">{{ user.borrowed_books|length }} books borrowed</span>
                    <span class="total-bookings">{{ user.user_bookings|length }} bookings made</span>
                    {% if user.gpa %}
                    <span class="reading-streak">GPA: {{ user.gpa }}</span>
                    {% else %}
                    <span class="reading-streak">{{ user.workshop_registrations|length }} workshops joined</span>
                    {% endif %}
                </div>
                {% if user.cohort_position %}
                <div class="cohort-info">
                    <span class="cohort-position">Academic standing: {{ user.cohort_position }}</span>
                </div>
                {% endif %}
            </div>
            
            <div class="contribution-graph">
                <div class="contribution-header">
                    <span class="contribution-text">Learn how we count contributions</span>
                    <div class="contribution-legend">
                        <span class="legend-text">Less</span>
                        <div class="legend-squares">
                            <div class="legend-square level-0"></div>
                            <div class="legend-square level-1"></div>
                            <div class="legend-square level-2"></div>
                            <div class="legend-square level-3"></div>
                            <div class="legend-square level-4"></div>
                        </div>
                        <span class="legend-text">More</span>
                    </div>
                </div>
                
                <div class="contribution-calendar">
                    <div class="month-labels">
                        <span>Jan</span>
                        <span>Feb</span>
                        <span>Mar</span>
                        <span>Apr</span>
                        <span>May</span>
                        <span>Jun</span>
                        <span>Jul</span>
                        <span>Aug</span>
                        <span>Sep</span>
                        <span>Oct</span>
                        <span>Nov</span>
                        <span>Dec</span>
                    </div>
                    
                    <div class="calendar-grid">
                        <div class="day-labels">
                            <span>Mon</span>
                            <span>Wed</span>
                            <span>Fri</span>
                        </div>
                        <div class="contribution-grid" id="contributionGrid">
                            <!-- Grid will be generated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="upcoming-activity card">
            <h3>Upcoming Activities</h3>
            
            <div class="activities-container">
                {% if user.workshop_registrations %}
                    {% for workshop in user.workshop_registrations %}
                    <div class="activity-block">
                        <div class="activity-date-block">
                            {% set date_parts = workshop.date.split('-') %}
                            <span class="day-number">{{ date_parts[2] }}</span>
                            <span class="month-abbr">
                                {% if date_parts[1] == '09' %}Sep{% elif date_parts[1] == '10' %}Oct{% elif date_parts[1] == '11' %}Nov{% elif date_parts[1] == '12' %}Dec{% else %}{{ date_parts[1] }}{% endif %}
                            </span>
                        </div>
                        <div class="activity-content">
                            <h4 class="activity-title">{{ workshop.name }}</h4>
                            <div class="activity-info">
                                <div class="info-row">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Venue: Library Workshop Room</span>
                                </div>
                                <div class="info-row">
                                    <i class="fas fa-user"></i>
                                    <span>Instructor: {{ workshop.instructor }}</span>
                                </div>
                                <div class="info-row">
                                    <i class="fas fa-clock"></i>
                                    <span>Time: {{ workshop.time }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <!-- Default activities if no workshops registered -->
                    <div class="activity-block">
                        <div class="activity-date-block">
                            <span class="day-number">10</span>
                            <span class="month-abbr">Sep</span>
                        </div>
                        <div class="activity-content">
                            <h4 class="activity-title">Introduction of 3D printer</h4>
                            <div class="activity-info">
                                <div class="info-row">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Venue: Yeung B7510</span>
                                </div>
                                <div class="info-row">
                                    <i class="fas fa-user"></i>
                                    <span>Instructor: Prof. Howard Leung</span>
                                </div>
                                <div class="info-row">
                                    <i class="fas fa-clock"></i>
                                    <span>Time: 2:00 PM - 4:00 PM</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="activity-block">
                        <div class="activity-date-block">
                            <span class="day-number">15</span>
                            <span class="month-abbr">Sep</span>
                        </div>
                        <div class="activity-content">
                            <h4 class="activity-title">Advanced Programming Workshop</h4>
                            <div class="activity-info">
                                <div class="info-row">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Venue: Computer Lab A301</span>
                                </div>
                                <div class="info-row">
                                    <i class="fas fa-user"></i>
                                    <span>Instructor: Dr. Sarah Chen</span>
                                </div>
                                <div class="info-row">
                                    <i class="fas fa-clock"></i>
                                    <span>Time: 10:00 AM - 12:00 PM</span>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
            
            <button class="show-more-btn">
                <i class="fas fa-chevron-down"></i>
                Show more activities
            </button>
        </section>

        <section class="intranet-apps card">
            <h3>My Intranet App</h3>
            <div class="intranet-grid">
                <div class="intranet-app-item">
                    <div class="app-icon aims">
                        <span>AIMS</span>
                    </div>
                    <div class="app-name">AIMS</div>
                    <div class="app-menu">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                </div>
                
                <div class="intranet-app-item">
                    <div class="app-icon canvas">
                        <i class="fas fa-palette"></i>
                        <span>canvas</span>
                    </div>
                    <div class="app-name">Canvas</div>
                    <div class="app-menu">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                </div>
                
                <div class="intranet-app-item">
                    <div class="app-icon profile">
                        <i class="fas fa-user-cog"></i>
                    </div>
                    <div class="app-name">My CityU Profile</div>
                    <div class="app-menu">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                </div>
            </div>
        </section>

        <section class="third-party-apps card">
            <h3>3 Party Applications</h3>
            <div class="third-party-list">
                <div class="third-party-app-item">
                    <div class="app-info">
                        <div class="app-icon-large grammarly">
                            <i class="fas fa-spell-check"></i>
                        </div>
                        <div class="app-details">
                            <h4>grammarly</h4>
                            <p>Writing assistant for students</p>
                        </div>
                    </div>
                    <button class="app-action-btn apply">Apply</button>
                </div>
                
                <div class="third-party-app-item">
                    <div class="app-info">
                        <div class="app-icon-large gmail">
                            <i class="fab fa-google"></i>
                        </div>
                        <div class="app-details">
                            <h4>Gmail</h4>
                            <p>University email access</p>
                        </div>
                    </div>
                    <button class="app-action-btn achieved">
                        <i class="fas fa-check"></i>
                        Achieve
                    </button>
                </div>
            </div>
        </section>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='profile.js') }}"></script>
{% endblock %}