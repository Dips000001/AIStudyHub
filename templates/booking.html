{% extends "layout.html" %}
{% block title %}Booking{% endblock %}
{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='booking.css') }}">
{% endblock %}
{% block content %}
<div class="booking-container">
    <div class="booking-header">
        <h1>Comprehensive Booking System</h1>
        <p>Book study rooms, special facilities, devices, and register for workshops</p>
    </div>

    <!-- Search and Filter Section -->
    <div class="search-filter-section">
        <input type="text" id="searchInput" placeholder="Search for resources..." class="search-input">
        <select class="filter-select" id="filterSelect">
            <option value="all">All Categories</option>
            <option value="study-rooms">Study Rooms</option>
            <option value="special-rooms">Special Rooms</option>
            <option value="devices">Devices</option>
            <option value="workshops">Workshops</option>
        </select>
        <button class="search-button" onclick="searchResources()">Search</button>
    </div>

    <!-- Tabbed Layout for Booking Categories -->
    <div class="tab-layout">
        <div class="tab-header">
            <button class="tab-link active" onclick="openCategory('study-rooms')">Study Rooms</button>
            <button class="tab-link" onclick="openCategory('special-rooms')">Special Rooms</button>
            <button class="tab-link" onclick="openCategory('devices')">Devices</button>
            <button class="tab-link" onclick="openCategory('workshops')">Workshops</button>
        </div>

        <!-- Study Rooms Category -->
        <div id="study-rooms" class="tab-content active study-rooms">
            <h2>Study Rooms</h2>
            <p>Book individual and group study rooms for focused learning sessions.</p>
            <div class="resource-grid">
                {% for room in study_rooms %}
                <div class="resource-card">
                    <div class="resource-placeholder">
                        <i class="{{ room.icon }}" style="font-size: 3rem; margin-bottom: 10px;"></i><br>
                        {{ room.type|title }} Study Room
                    </div>
                    <div class="resource-info">
                        <h3 class="resource-title">{{ room.name }}</h3>
                        <p class="resource-description">{{ room.description }}</p>
                        <div class="resource-details">
                            <span class="capacity">Capacity: {{ room.capacity }} person{% if room.capacity != 1 %}s{% endif %}</span>
                            <span class="availability {% if room.availability == 'occupied' %}unavailable{% endif %}">
                                {% if room.availability == 'available' %}Available{% else %}{{ room.availability|title }}{% endif %}
                            </span>
                        </div>
                        <div class="resource-actions">
                            {% if room.availability == 'available' %}
                                <button class="btn btn-primary" onclick="bookResource('{{ room.id }}', 'study_room')">Book Now</button>
                            {% else %}
                                <button class="btn btn-secondary" disabled>Currently {{ room.availability|title }}</button>
                                <button class="btn btn-info" onclick="joinWaitlist('{{ room.id }}')">Join Waitlist</button>
                            {% endif %}
                            <button class="btn btn-secondary" onclick="viewDetails('{{ room.id }}')">View Details</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Special Rooms Category -->
        <div id="special-rooms" class="tab-content special-rooms">
            <h2>Special Rooms</h2>
            <p>Book specialized facilities for presentations, meetings, and collaborative work.</p>
            <div class="resource-grid">
                {% for room in special_rooms %}
                <div class="resource-card">
                    <div class="resource-placeholder">
                        <i class="{{ room.icon }}" style="font-size: 3rem; margin-bottom: 10px;"></i><br>
                        {{ room.type|title }} Room
                    </div>
                    <div class="resource-info">
                        <h3 class="resource-title">{{ room.name }}</h3>
                        <p class="resource-description">{{ room.description }}</p>
                        <div class="resource-details">
                            <span class="capacity">Capacity: {{ room.capacity }} people</span>
                            <span class="availability {% if room.availability != 'available' %}unavailable{% endif %}">
                                {% if room.availability == 'available' %}Available{% else %}{{ room.availability|replace('_', ' ')|title }}{% endif %}
                            </span>
                        </div>
                        <div class="resource-actions">
                            {% if room.availability == 'available' %}
                                <button class="btn btn-primary" onclick="bookResource('{{ room.id }}', 'special_room')">Book Now</button>
                            {% else %}
                                <button class="btn btn-secondary" disabled>Currently {{ room.availability|replace('_', ' ')|title }}</button>
                                <button class="btn btn-info" onclick="joinWaitlist('{{ room.id }}')">Join Waitlist</button>
                            {% endif %}
                            <button class="btn btn-secondary" onclick="viewDetails('{{ room.id }}')">View Details</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Devices Category -->
        <div id="devices" class="tab-content devices">
            <h2>Devices</h2>
            <p>Borrow specialized equipment and devices for your projects and presentations.</p>
            <div class="resource-grid">
                {% for device in devices %}
                <div class="resource-card">
                    <div class="resource-placeholder">
                        <i class="{{ device.icon }}" style="font-size: 3rem; margin-bottom: 10px;"></i><br>
                        {{ device.type|replace('_', ' ')|title }}
                    </div>
                    <div class="resource-info">
                        <h3 class="resource-title">{{ device.name }}</h3>
                        <p class="resource-description">{{ device.description }}</p>
                        <div class="resource-details">
                            <span class="capacity">{{ device.capacity }}</span>
                            <span class="availability {% if device.availability != 'available' %}unavailable{% endif %}">
                                {% if device.availability == 'available' %}Available{% else %}{{ device.availability|replace('_', ' ')|title }}{% endif %}
                            </span>
                        </div>
                        <div class="resource-actions">
                            {% if device.availability == 'available' %}
                                <button class="btn btn-primary" onclick="bookResource('{{ device.id }}', 'device')">Book Now</button>
                            {% else %}
                                <button class="btn btn-secondary" disabled>Currently {{ device.availability|replace('_', ' ')|title }}</button>
                                <button class="btn btn-info" onclick="joinWaitlist('{{ device.id }}')">Join Waitlist</button>
                            {% endif %}
                            <button class="btn btn-secondary" onclick="viewDetails('{{ device.id }}')">View Details</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Workshops Category -->
        <div id="workshops" class="tab-content workshops">
            <h2>Workshop Registration</h2>
            <p>Register for educational workshops and training sessions to enhance your skills.</p>
            <div class="resource-grid">
                {% for workshop in workshops %}
                <div class="resource-card">
                    <div class="resource-placeholder">
                        <i class="{{ workshop.icon }}" style="font-size: 3rem; margin-bottom: 10px;"></i><br>
                        {{ workshop.type|replace('_', ' ')|title }} Workshop
                    </div>
                    <div class="resource-info">
                        <h3 class="resource-title">{{ workshop.name }}</h3>
                        <p class="resource-description">{{ workshop.description }}</p>
                        <div class="resource-details">
                            <span class="capacity">{{ workshop.available_spots }} spots available</span>
                            <span class="availability {% if workshop.availability != 'registration_open' %}unavailable{% endif %}">
                                {% if workshop.availability == 'registration_open' %}Registration Open{% else %}{{ workshop.availability|replace('_', ' ')|title }}{% endif %}
                            </span>
                        </div>
                        <div class="resource-actions">
                            {% if workshop.id in user_workshop_registrations %}
                                <button class="btn btn-warning" onclick="deregisterWorkshop('{{ workshop.id }}')">Deregister</button>
                                <span style="color: green; font-weight: bold; margin-left: 10px;">âœ“ Registered</span>
                            {% elif workshop.availability == 'registration_open' and workshop.available_spots > 0 %}
                                <button class="btn btn-success" onclick="registerWorkshop('{{ workshop.id }}')">Register</button>
                            {% else %}
                                <button class="btn btn-secondary" disabled>{{ workshop.availability|replace('_', ' ')|title }}</button>
                                {% if workshop.available_spots <= 0 %}
                                    <button class="btn btn-warning" onclick="joinWaitlist('{{ workshop.id }}')">Join Waitlist</button>
                                {% endif %}
                            {% endif %}
                            <button class="btn btn-secondary" onclick="viewDetails('{{ workshop.id }}')">View Details</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
function openCategory(categoryName) {
    // Hide all tab contents
    var tabContents = document.getElementsByClassName("tab-content");
    for (var i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove("active");
    }
    
    // Remove active class from all tab links
    var tabLinks = document.getElementsByClassName("tab-link");
    for (var i = 0; i < tabLinks.length; i++) {
        tabLinks[i].classList.remove("active");
    }
    
    // Show selected tab content and mark tab as active
    document.getElementById(categoryName).classList.add("active");
    event.currentTarget.classList.add("active");
}

function searchResources() {
    var searchTerm = document.getElementById('searchInput').value.toLowerCase();
    var filterValue = document.getElementById('filterSelect').value;
    var cards = document.getElementsByClassName('resource-card');
    
    for (var i = 0; i < cards.length; i++) {
        var card = cards[i];
        var title = card.querySelector('.resource-title').textContent.toLowerCase();
        var description = card.querySelector('.resource-description').textContent.toLowerCase();
        var parentTab = card.closest('.tab-content').id;
        
        var matchesSearch = title.includes(searchTerm) || description.includes(searchTerm);
        var matchesFilter = filterValue === 'all' || parentTab === filterValue;
        
        if (matchesSearch && matchesFilter) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    }
    
    // If filtering by category, switch to that tab
    if (filterValue !== 'all') {
        openCategoryByName(filterValue);
    }
}

function openCategoryByName(categoryName) {
    // Hide all tab contents
    var tabContents = document.getElementsByClassName("tab-content");
    for (var i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove("active");
    }
    
    // Remove active class from all tab links
    var tabLinks = document.getElementsByClassName("tab-link");
    for (var i = 0; i < tabLinks.length; i++) {
        tabLinks[i].classList.remove("active");
    }
    
    // Show selected tab content and mark corresponding tab as active
    document.getElementById(categoryName).classList.add("active");
    
    // Find and activate the corresponding tab link
    var tabButtons = document.querySelectorAll('.tab-link');
    tabButtons.forEach(function(button) {
        if (button.getAttribute('onclick').includes(categoryName)) {
            button.classList.add('active');
        }
    });
}

function bookResource(resourceId, resourceType) {
    // Create a modal for booking details
    const bookingForm = `
        <div id="bookingModal" style="
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000;">
            <div style="
                background: white; 
                padding: 20px; 
                border-radius: 8px; 
                max-width: 400px; 
                width: 90%;">
                <h3>Book Resource</h3>
                <form id="bookingFormData">
                    <div style="margin-bottom: 15px;">
                        <label>Date:</label>
                        <input type="date" id="bookingDate" required style="width: 100%; padding: 8px; margin-top: 5px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label>Start Time:</label>
                        <input type="time" id="startTime" required style="width: 100%; padding: 8px; margin-top: 5px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label>End Time:</label>
                        <input type="time" id="endTime" required style="width: 100%; padding: 8px; margin-top: 5px;">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" style="flex: 1; padding: 10px; background: #007bff; color: white; border: none; border-radius: 4px;">Book Now</button>
                        <button type="button" onclick="closeBookingModal()" style="flex: 1; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 4px;">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', bookingForm);
    
    // Set minimum date to today
    document.getElementById('bookingDate').min = new Date().toISOString().split('T')[0];
    
    // Handle form submission
    document.getElementById('bookingFormData').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const bookingData = {
            resource_id: resourceId,
            resource_type: resourceType,
            date: document.getElementById('bookingDate').value,
            start_time: document.getElementById('startTime').value,
            end_time: document.getElementById('endTime').value
        };
        
        fetch('/api/book-resource', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(bookingData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Resource booked successfully!');
                closeBookingModal();
                location.reload(); // Refresh to update availability
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while booking the resource.');
        });
    });
}

function closeBookingModal() {
    const modal = document.getElementById('bookingModal');
    if (modal) {
        modal.remove();
    }
}

function viewDetails(resourceId) {
    fetch(`/api/get-resource-details/${resourceId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const resource = data.resource;
                let detailsHtml = `
                    <div id="detailsModal" style="
                        position: fixed; 
                        top: 0; 
                        left: 0; 
                        width: 100%; 
                        height: 100%; 
                        background: rgba(0,0,0,0.5); 
                        display: flex; 
                        justify-content: center; 
                        align-items: center; 
                        z-index: 1000;">
                        <div style="
                            background: white; 
                            padding: 20px; 
                            border-radius: 8px; 
                            max-width: 500px; 
                            width: 90%; 
                            max-height: 80%; 
                            overflow-y: auto;">
                            <h3>${resource.name}</h3>
                            <p><strong>Description:</strong> ${resource.description}</p>
                            <p><strong>Capacity:</strong> ${resource.capacity}</p>
                            <p><strong>Type:</strong> ${resource.type}</p>
                            <p><strong>Availability:</strong> ${resource.availability}</p>
                `;
                
                if (resource.features) {
                    detailsHtml += `<p><strong>Features:</strong> ${resource.features.join(', ')}</p>`;
                }
                
                if (resource.date) {
                    detailsHtml += `<p><strong>Date:</strong> ${resource.date}</p>`;
                }
                
                if (resource.time) {
                    detailsHtml += `<p><strong>Time:</strong> ${resource.time}</p>`;
                }
                
                if (resource.instructor) {
                    detailsHtml += `<p><strong>Instructor:</strong> ${resource.instructor}</p>`;
                }
                
                detailsHtml += `
                            <button onclick="closeDetailsModal()" style="
                                padding: 10px 20px; 
                                background: #007bff; 
                                color: white; 
                                border: none; 
                                border-radius: 4px; 
                                margin-top: 15px;">Close</button>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', detailsHtml);
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while fetching resource details.');
        });
}

function closeDetailsModal() {
    const modal = document.getElementById('detailsModal');
    if (modal) {
        modal.remove();
    }
}

function registerWorkshop(workshopId) {
    if (confirm('Are you sure you want to register for this workshop?')) {
        fetch('/api/register-workshop', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({workshop_id: workshopId})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Workshop registration successful!');
                location.reload(); // Refresh to update availability
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while registering for the workshop.');
        });
    }
}

function deregisterWorkshop(workshopId) {
    if (confirm('Are you sure you want to deregister from this workshop?')) {
        fetch('/api/deregister-workshop', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({workshop_id: workshopId})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Workshop deregistration successful!');
                location.reload(); // Refresh to update availability
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deregistering from the workshop.');
        });
    }
}

function joinWaitlist(resourceId) {
    if (confirm('Would you like to join the waitlist for this resource?')) {
        fetch('/api/join-waitlist', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({resource_id: resourceId})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Added to waitlist successfully! You will be notified when the resource becomes available.');
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while joining the waitlist.');
        });
    }
}

// Initialize search functionality
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('searchInput').addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            searchResources();
        }
    });
});
</script>
{% endblock %}